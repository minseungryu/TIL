## 로그인/비로그인 사용자 구분 집계

- user_id가 NULL이면 '' 을 반환, 값이 있으면 그대로 user_id를 반환

- user_id가 반환되면, 즉, 빈값이 아니면 login을 반환하고 빈 값이면 guest 반환

```postgresql
WITH 
ACTION_log_with_status AS (
	SELECT session
		, user_id
		, ACTION
		-- user_id가 null이면 로그인으로 판정
		, CASE WHEN COALESCE(user_id, '') <> '' THEN 'login' ELSE 'guset' END AS login_status
	FROM action_log
)
SELECT *
FROM ACTION_log_with_status
;
```



- login_status를 기반으로 액션수와 UU를 집계
- 추가로 로그인/비로그인을 따지지 않고 전체(all)도 함께 집계 👉 **ROLLUP** 구문 사용

```postgresql
WITH 
ACTION_log_with_status AS (
	SELECT SESSION
		, user_id
		, ACTION
		-- user_id가 null이면 로그인으로 판정
		, CASE WHEN COALESCE(user_id, '') != '' THEN 'login' ELSE 'guset' END AS login_status
	FROM action_log
)
SELECT 
	coalesce(ACTION, 'all') AS "action"
	,coalesce(login_status, 'all') AS login_status
	,count(DISTINCT session) AS action_uu
	,count(1) AS action_count
FROM ACTION_log_with_status
GROUP BY ROLLUP(action, login_status)
;
```

