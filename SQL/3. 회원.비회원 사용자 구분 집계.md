## 회원/비회원 사용자를 구분하여 집계

- 로그인을 하지 않았더라도, 이전에 한 번이라도 로그인했다면 회원으로 간주하고 계산하는 경우
- 로그 데이터를 가공하여 회원 상태를 추가

1. 로그를 타임스탬프 순서로 나열하고, 세션 내에서 한번이라도 로그인한 사용자인지 확인
2. 해당 session에서 한 번이라도 로그인했다면 → 즉, user_id의 max 값이 빈값이 아니라면 Member를 반환하고 그렇지 않은 경우(로그인 하지 않음) none을 반환

```postgresql
WITH
action_log_with_status AS (
	SELECT "session"
		, user_id
		, "action"
		-- 로그를 타임스탬프 순서로 나열
  	-- 한번이라도 로그인한 사용자라면 > 이후 로그를 모두 member로 설정 
		, CASE WHEN coalesce(max(user_id)
				OVER (PARTITION BY SESSION ORDER BY stamp ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW), '') 
				<> '' THEN 'member' ELSE 'none' END AS member_status
		, stamp
	FROM action_log 
)
SELECT *
FROM action_log_with_status
;
```

