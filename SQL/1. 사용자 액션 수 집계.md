### 사용자의 액션 수 집계

- 사용자가 서비스 내부에서 제공되는 기능을 얼마나 이용하는지 집계하는 작업은 사용자 행동 패턴 파악할 때와 어떤 액션의 효과를 확인할 때 매우 중요하다.
- 사용률(usage_rate)과 1명 당 액션 수(count_per_user)를 각각 구해보자.

---

1. 전체 사용자 수를 먼저 구한다.
2. 전체 사용자수를 액션 로그 데이터와 CROSS JOIN 한다.
3. 액션 별로 유니크한 사용자 수와 액션 수를 카운트 한다.
4. 액션 uu와 액션 수를 활용하여 사용률과 1인당 액션 수를 계산한다.

```sql
WITH stats AS (
	-- 로그 전체에서 유니크한 사용자 수(unique users) 
	SELECT count(DISTINCT session) AS total_uu
	FROM action_log 
)
SELECT l.ACTION
	, count(DISTINCT l."session") AS action_uu -- 액션 별 유니크 사용자 수(uu) 
	, count(1) AS action_count -- 액션의 수 
	, s.total_uu --전체 uu 
	, 100.0 * count(DISTINCT l.session) / s.total_uu AS usage_rate -- 사용률:액션uu / 전체uu 
	, 1.0 * count(1) / count(DISTINCT l.session) AS count_per_user -- 1인당 액션 수 : 액션수 / 액션 uu
FROM action_log AS l
CROSS JOIN stats AS s -- 로그 전체의 유니크 사용자 수를 모든 레코드에 결합 
GROUP BY l.ACTION, s.total_uu
;
```

